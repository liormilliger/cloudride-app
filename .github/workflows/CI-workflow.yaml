name: CI Build, ECR Push, and K8s Manifest Update

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
  workflow_dispatch:

env:
  ECR_REGION: us-west-2
  ECR_REPOSITORY_NAME: liorm-cloudride
  K8S_REPO: liormilliger/cloudride-k8s
  K8S_REPO_PATH: cloudride-k8s

jobs:
  build_and_scan:
    runs-on: ubuntu-latest
    # This output is no longer used by downstream jobs, but we keep it for reference
    outputs:
      image_uri: ${{ steps.image_info.outputs.full_image_uri }}:${{ github.run_number }}
    steps:
      - uses: actions/checkout@v4
      - name: Define ECR Registry and Full URI
        id: image_info
        run: |
          ECR_REGISTRY_HOST=${{ secrets.ACCOUNT_ID }}.dkr.ecr.${{ env.ECR_REGION }}.amazonaws.com
          FULL_IMAGE_URI=$ECR_REGISTRY_HOST/${{ env.ECR_REPOSITORY_NAME }}
          echo "full_image_uri=$FULL_IMAGE_URI" >> $GITHUB_OUTPUT
      - name: Build Docker Image
        id: build
        run: docker build -t ${{ steps.image_info.outputs.full_image_uri }}:${{ github.run_number }} ./app
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.image_info.outputs.full_image_uri }}:${{ github.run_number }}
          format: sarif
          output: trivy-results.sarif
          ignore-unfixed: true
          exit-code: 0
      - name: Save Trivy SARIF results for next job
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif
          path: trivy-results.sarif

  # --- The 'publish_scan_results' job has been removed as requested. ---

  push_to_ecr:
    runs-on: ubuntu-latest
    needs: build_and_scan
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.ECR_REGION }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Define ECR Registry and Full URI (Needed again to access ECR_REPOSITORY_NAME)
        id: image_info
        run: |
          ECR_REGISTRY_HOST=${{ secrets.ACCOUNT_ID }}.dkr.ecr.${{ env.ECR_REGION }}.amazonaws.com
          FULL_IMAGE_URI=$ECR_REGISTRY_HOST/${{ env.ECR_REPOSITORY_NAME }}
          echo "full_image_uri=$FULL_IMAGE_URI" >> $GITHUB_OUTPUT
      # NOTE: Rebuilds the image as artifacts from 'build_and_scan' are not shared by default.
      - name: Build Docker Image for Push
        run: docker build -t ${{ steps.image_info.outputs.full_image_uri }}:push-temp ./app
      - name: Tag Images
        run: |
          # The image tag is the GitHub run number
          docker tag ${{ steps.image_info.outputs.full_image_uri }}:push-temp ${{ steps.image_info.outputs.full_image_uri }}:${{ github.run_number }}
          # Also tag as 'latest'
          docker tag ${{ steps.image_info.outputs.full_image_uri }}:push-temp ${{ steps.image_info.outputs.full_image_uri }}:latest
      - name: Push Images to ECR
        run: |
          docker push ${{ steps.image_info.outputs.full_image_uri }}:${{ github.run_number }}
          docker push ${{ steps.image_info.outputs.full_image_uri }}:latest

  update_k8s_manifest:
    runs-on: ubuntu-latest
    needs: push_to_ecr # Wait for the image push to complete
    permissions:
      contents: write # Required for pushing changes to the K8s repository
    steps:
      - name: Checkout K8s Manifest Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.K8S_REPO }}
          # IMPORTANT: Must use a PAT with 'repo' scope to push to an external repository
          token: ${{ secrets.K8S_DEPLOYMENT_TOKEN }}
          path: ${{ env.K8S_REPO_PATH }}
          ref: main # Target branch for the K8s repo

      - name: Update values.yaml with new image tag
        run: |
          NEW_TAG=${{ github.run_number }}
          VALUES_FILE="${{ env.K8S_REPO_PATH }}/my-app-chart/values.yaml"
          
          # Use sed to find the 'tag:' line and replace the value with the new run number.
          # This handles spaces before the 'tag' key.
          sed -i "s|^[[:space:]]*tag: .*|tag: \"$NEW_TAG\"|" "$VALUES_FILE"
          
          echo "Successfully updated $VALUES_FILE with tag: $NEW_TAG"
          # Optional: Print the updated file content for debugging
          # cat "$VALUES_FILE"

      - name: Commit and Push changes
        run: |
          cd ${{ env.K8S_REPO_PATH }}
          # Set Git identity for the commit
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          # Check if there are changes to commit (prevents failure if no change was made)
          if ! git diff --exit-code; then
            git add values.yaml
            git commit -m "Deployment: Update application image tag to ${{ github.run_number }}"
            git push
          else
            echo "values.yaml already contains tag ${{ github.run_number }}. No commit necessary."
          fi
